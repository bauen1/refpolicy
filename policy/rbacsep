#
# Define the constraints
#
# constrain class_set perm_set expression ;
#
# expression : ( expression )
#	     | not expression
#	     | expression and expression
#	     | expression or expression
#	     | u1 op u2
#	     | r1 role_op r2
#	     | t1 op t2
#	     | u1 op names
#	     | u2 op names
#	     | r1 op names
#	     | r2 op names
#	     | t1 op names
#	     | t2 op names
#
# op : == | !=
# role_op : == | != | eq | dom | domby | incomp
#
# names : name | { name_list }
# name_list : name | name_list name
#

ifdef(`enable_rbacsep', `
#    constrain dir all_dir_perms
#    (
#        r1 == r2
#        or r2 == rbacsep_target_exempt
#        or r1 == rbacsep_source_exempt
#    );
#
#    constrain file all_file_perms
#    (
#        r1 == r2
#        or r2 == rbacsep_target_exempt
#        or r1 == rbacsep_source_exempt
#    );

    # rbacsep_constrained_target_type_attribute: all types that are shared between "users"
    # e.g. user_t, user_home_content_type, ...

    #######################################################
    # constrain file all_file_perms -read_file_perms
    #
    # rbacsep exempted roles get access to everything that isnt specifically constrained
    #
    # and all domains can write/execute/... to exempted roles (assuming they are permitted by TE)
    constrain file { write create setattr relabelfrom relabelto append map unlink link rename execute quotaon mounton audit_access execmod watch watch_mount watch_sb watch_with_perm watch_reads }
    (
        r1 == r2
        or t1 == rbacsep_exempt_uncond_type_attribute

        or (
            r1 == rbacsep_exempt_role_attribute
            and t1 != rbacsep_constrained_subject_type_attribute
        )

        or (
            r2 == rbacsep_exempt_role_attribute
            and t2 != rbacsep_constrained_target_type_attribute
        )
    );

    #######################################################
    # constrain file read_file_perms:
    # rbacsep exempted roles get access to everything that isnt specifically constrained
    #
    # every role gets access to rbacsep exempted role unless the type is specifically constrained,
    # this way "sudo nano /etc/abc" as sysadm_r works, but processes or home files from sysadm_r wont
    # be readable to every other role
    constrain file { getattr ioctl lock open read }
    (
        r1 == r2
        or t1 == rbacsep_exempt_uncond_type_attribute

        or (
            r1 == rbacsep_exempt_role_attribute
            and t1 != rbacsep_constrained_subject_type_attribute
        )

        or (
            r2 == rbacsep_exempt_role_attribute
            and t2 != rbacsep_constrained_target_type_attribute
        )
    );
')
